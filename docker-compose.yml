services:
  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: anythingllm
    ports:
      - "3001:3001"
    environment:
      - STORAGE_DIR=/app/server/storage
    volumes:
      - ./data:/app/server/storage
      - ./data/.env:/app/server/.env
    restart: unless-stopped

  proxy:
    build: ./go-proxy
    container_name: anythingllm-proxy
    depends_on:
      - anythingllm
    environment:
      - PORT=8080
      - ANYLLM_URL=http://anythingllm:3001
      - ANYLLM_API_KEY=${ANYLLM_API_KEY:-XN6FD4N-26N4BXR-JXS1DT9-F2D8MHT}
      - ANYLLM_AUTO_CREATE=false
      - ANYLLM_DEFAULT_ROLE=user
      # Internal URL for proxy->Keycloak communication (via shared Docker network)
      - KEYCLOAK_ISSUER_URL=${KEYCLOAK_ISSUER_URL:-http://keycloak:8080/realms/mapache}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-mapache-client}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-7HMLGYoxhKIjmOQZkK9Bp1z3oamucLIc}
      - KEYCLOAK_REDIRECT_URL=${KEYCLOAK_REDIRECT_URL:-http://localhost:8080/auth/callback}
      # External URL for browser redirects (what users see)
      - KEYCLOAK_EXTERNAL_URL=${KEYCLOAK_EXTERNAL_URL:-http://localhost:8180/realms/mapache}
      - SESSION_SECRET=${SESSION_SECRET:-hzo9edRqjnSGhBpKnjxkGZv62eNmfOJknhB0v95Otdc=}
      - SESSION_SECURE=false
      - BANNER_TOP_TEXT=${BANNER_TOP_TEXT:-SITE UNDER TEST}
      - BANNER_BOTTOM_TEXT=${BANNER_BOTTOM_TEXT:-SITE UNDER TEST}
      - BANNER_BG_COLOR=${BANNER_BG_COLOR:-#f6f000}
      - BANNER_TEXT_COLOR=${BANNER_TEXT_COLOR:-#000000}
      - AGREEMENT_TITLE=${AGREEMENT_TITLE:-User Agreement}
      - AGREEMENT_BODY=${AGREEMENT_BODY:-Please acknowledge and accept this agreement to continue.}
      - AGREEMENT_BUTTON_TEXT=${AGREEMENT_BUTTON_TEXT:-OK}
      - DEBUG_LOGGING=${DEBUG_LOGGING:-true}
      - SECURITY_LOGGING=${SECURITY_LOGGING:-true}
      - DEBUG_HTTP=${DEBUG_HTTP:-true}
      - ACCESS_LOGGING=${ACCESS_LOGGING:-true}
      - METRICS_ENABLED=${METRICS_ENABLED:-false}
      - READINESS_CHECKS=${READINESS_CHECKS:-false}
      - READINESS_URL=${READINESS_URL:-}
      - READINESS_TIMEOUT=${READINESS_TIMEOUT:-2s}
      - SESSION_SAMESITE=${SESSION_SAMESITE:-lax}
      - SESSION_MAX_AGE_DAYS=${SESSION_MAX_AGE_DAYS:-7}
      - SESSION_HTTP_ONLY=${SESSION_HTTP_ONLY:-true}
      - READ_TIMEOUT=${READ_TIMEOUT:-15s}
      - WRITE_TIMEOUT=${WRITE_TIMEOUT:-15s}
      - READ_HEADER_TIMEOUT=${READ_HEADER_TIMEOUT:-5s}
      - IDLE_TIMEOUT=${IDLE_TIMEOUT:-60s}
      - SHUTDOWN_TIMEOUT=${SHUTDOWN_TIMEOUT:-10s}
      - MAX_HEADER_BYTES=${MAX_HEADER_BYTES:-1048576}
      - UPSTREAM_DIAL_TIMEOUT=${UPSTREAM_DIAL_TIMEOUT:-10s}
      - UPSTREAM_TLS_HANDSHAKE_TIMEOUT=${UPSTREAM_TLS_HANDSHAKE_TIMEOUT:-10s}
      - UPSTREAM_RESPONSE_HEADER_TIMEOUT=${UPSTREAM_RESPONSE_HEADER_TIMEOUT:-15s}
      - UPSTREAM_IDLE_TIMEOUT=${UPSTREAM_IDLE_TIMEOUT:-60s}
      - UPSTREAM_MAX_IDLE_CONNS=${UPSTREAM_MAX_IDLE_CONNS:-100}
      - UPSTREAM_MAX_IDLE_CONNS_PER_HOST=${UPSTREAM_MAX_IDLE_CONNS_PER_HOST:-10}
      - ANYLLM_HTTP_TIMEOUT=${ANYLLM_HTTP_TIMEOUT:-10s}
      - ANYLLM_RETRY_MAX=${ANYLLM_RETRY_MAX:-0}
      - ANYLLM_RETRY_BACKOFF=${ANYLLM_RETRY_BACKOFF:-200ms}
      - SECURITY_HEADERS=${SECURITY_HEADERS:-true}
      - HEADER_FRAME_OPTIONS=${HEADER_FRAME_OPTIONS:-SAMEORIGIN}
      - HEADER_REFERRER_POLICY=${HEADER_REFERRER_POLICY:-strict-origin-when-cross-origin}
      - HEADER_CSP=${HEADER_CSP:-}
      - HEADER_PERMISSIONS=${HEADER_PERMISSIONS:-geolocation=(), microphone=(), camera=()}
      - RATE_LIMIT_PER_MIN=${RATE_LIMIT_PER_MIN:-0}
      - RATE_LIMIT_BURST=${RATE_LIMIT_BURST:-0}
    networks:
      - default
      - kecloak_default
    ports:
      - "8080:8080"
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/healthz > /dev/null || exit 1"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 10s

networks:
  default:
    name: anythingllm_net
  kecloak_default:
    external: true
