# AnythingLLM Stack - Umbrella Chart Values
# This chart deploys: proxy (keycloak auth), anythingllm, and weaviate
#
# REQUIRED CONFIGURATION:
# 1. Set Keycloak URLs (proxy.env.KEYCLOAK_*)
# 2. Set ingress host (proxy.ingress.hosts[0].host)
# 3. Set SSO redirect URL (anythingllm.env.SIMPLE_SSO_NO_LOGIN_REDIRECT)
# 4. Set secrets at install time (see below)
#
# Example install:
#   helm install anythingllm . -n mynamespace \
#     --set proxy.env.KEYCLOAK_ISSUER_URL=https://keycloak.example.com/realms/myrealm \
#     --set proxy.env.KEYCLOAK_CLIENT_ID=my-client \
#     --set proxy.env.KEYCLOAK_REDIRECT_URL=https://app.example.com/auth/callback \
#     --set proxy.env.KEYCLOAK_EXTERNAL_URL=https://keycloak.example.com/realms/myrealm \
#     --set proxy.ingress.hosts[0].host=app.example.com \
#     --set anythingllm.env.SIMPLE_SSO_NO_LOGIN_REDIRECT=https://app.example.com/login \
#     --set proxy.secretEnv.KEYCLOAK_CLIENT_SECRET=xxx \
#     --set proxy.secretEnv.SESSION_SECRET=$(openssl rand -hex 32)

# Keycloak Proxy Configuration
proxy:
  image:
    registry: ""  # Set your registry
    repository: ""  # Set your repository
    tag: latest

  replicaCount: 1

  # Init container waits for AnythingLLM to be ready
  initContainers:
    waitForAnythingllm:
      enabled: true
      image: busybox:1.36
      host: anythingllm
      port: 3001
      sleepSeconds: 2

  ingress:
    enabled: true
    className: ""  # Set your ingress class (nginx, traefik, etc.)
    annotations: {}
    hosts:
      - host: ""  # REQUIRED: Set your hostname
        paths:
          - path: /
            pathType: Prefix
    tls: []

  env:
    PORT: "8080"
    # Internal service URL - usually doesn't need changing
    ANYLLM_URL: "http://anythingllm:3001"
    ANYLLM_AUTO_CREATE: "false"
    ANYLLM_DEFAULT_ROLE: "user"
    # REQUIRED: Configure these for your Keycloak instance
    KEYCLOAK_ISSUER_URL: ""      # e.g., https://keycloak.example.com/realms/myrealm
    KEYCLOAK_CLIENT_ID: ""       # e.g., my-client
    KEYCLOAK_REDIRECT_URL: ""    # e.g., https://app.example.com/auth/callback
    KEYCLOAK_EXTERNAL_URL: ""    # e.g., https://keycloak.example.com/realms/myrealm
    # Session settings - set SESSION_SECURE=true for HTTPS
    SESSION_SECURE: "false"
    SESSION_SAMESITE: "lax"
    SESSION_MAX_AGE_DAYS: "7"

  # REQUIRED: Set these secrets at install time
  # --set proxy.secretEnv.KEYCLOAK_CLIENT_SECRET=xxx
  # --set proxy.secretEnv.SESSION_SECRET=$(openssl rand -hex 32)
  secretEnv:
    ANYLLM_API_KEY: ""           # Optional: AnythingLLM API key for user sync
    KEYCLOAK_CLIENT_SECRET: ""   # REQUIRED: From Keycloak client
    SESSION_SECRET: ""           # REQUIRED: Random 32+ char string

# AnythingLLM Configuration
anythingllm:
  image:
    registry: ""  # Set your registry
    repository: ""  # Set your repository
    tag: latest

  replicaCount: 1

  # Init container waits for Weaviate to be ready
  initContainers:
    waitForWeaviate:
      enabled: true
      image: busybox:1.36
      host: weaviate
      port: 80
      sleepSeconds: 2

  persistence:
    enabled: true
    storageClass: ""  # Set your storage class
    size: 10Gi

  env:
    STORAGE_DIR: /app/server/storage
    SIMPLE_SSO_ENABLED: "true"
    SIMPLE_SSO_NO_LOGIN: "true"
    # REQUIRED: Set to your proxy URL
    SIMPLE_SSO_NO_LOGIN_REDIRECT: ""  # e.g., https://app.example.com/login
    VECTOR_DB: "weaviate"
    # Internal service URL - usually doesn't need changing
    WEAVIATE_ENDPOINT: "http://weaviate:80"
    # JWT_SECRET: Leave empty to auto-generate (persisted across upgrades)
    # Or set explicitly: --set anythingllm.env.JWT_SECRET=$(openssl rand -hex 32)
    JWT_SECRET: ""

  secretEnv:
    WEAVIATE_API_KEY: ""  # Optional: Set if Weaviate auth is enabled

# Weaviate Vector Database Configuration
weaviate:
  weaviate:
    replicas: 1

    image:
      tag: "1.34.0"

    service:
      type: ClusterIP
      port: 8080

    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: "1"
        memory: 2Gi

    persistence:
      enabled: true
      storageClass: ""  # Set your storage class
      size: 10Gi

    grpcService:
      enabled: false

    initContainers:
      sysctlInitContainer:
        enabled: false
