{{- if not .Values.existingSecret }}
{{- $secretName := include "anythingllm.fullname" . -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "anythingllm.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- /* Handle JWT_SECRET: use existing, then provided, then generate new */}}
  {{- $jwtSecret := "" }}
  {{- if and $existingSecret $existingSecret.data }}
    {{- $jwtSecret = index $existingSecret.data "JWT_SECRET" | default "" | b64dec }}
  {{- end }}
  {{- if not $jwtSecret }}
    {{- if .Values.env.JWT_SECRET }}
      {{- $jwtSecret = .Values.env.JWT_SECRET }}
    {{- else }}
      {{- $jwtSecret = randAlphaNum 64 }}
    {{- end }}
  {{- end }}
  JWT_SECRET: "{{ $jwtSecret }}"
  {{- range $key, $val := .Values.secretEnv }}
  {{ $key }}: "{{ $val }}"
  {{- end }}
{{- end }}
