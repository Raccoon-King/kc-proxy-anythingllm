workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

stages:
  - ai-policy
  - lint
  - test
  - scan
  - build
  - deploy

variables:
  HARBOR_REGISTRY: "harbor.localhost"
  HARBOR_PROJECT: "mapache"
  GO_IMAGE: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/keycloak-proxy-go"
  NODE_IMAGE: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/keycloak-proxy-node"

# ===========================================
# AI POLICY GATE
# ===========================================
ai-policy-gate:
  stage: ai-policy
  image: alpine:3.19
  before_script:
    - apk add --no-cache bash jq
  script:
    - echo "=== AI Policy Gate ===" && echo "PASSED"
  allow_failure: true

# ===========================================
# TEMPLATES
# ===========================================
.go_template: &go_template
  image: golang:1.24
  rules:
    - exists:
        - go-proxy/go.mod

.node_template: &node_template
  image: node:20
  rules:
    - exists:
        - proxy/package.json

.docker_template: &docker_template
  image: docker:26.1.0
  services:
    - name: docker:26.1.0-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""

# ===========================================
# LINT
# ===========================================
go_lint:
  stage: lint
  <<: *go_template
  script:
    - cd go-proxy
    - go fmt ./...
    - go vet ./...
  needs: ["ai-policy-gate"]

node_lint:
  stage: lint
  <<: *node_template
  script:
    - cd proxy
    - npm ci
    - npm run lint --if-present
  needs: ["ai-policy-gate"]
  allow_failure: true

# ===========================================
# TEST
# ===========================================
go_test:
  stage: test
  <<: *go_template
  script:
    - cd go-proxy
    - go test ./... -cover -v
  coverage: '/coverage: \d+\.\d+%/'
  needs: ["go_lint"]

node_test:
  stage: test
  <<: *node_template
  script:
    - cd proxy
    - npm ci
    - npm test --if-present
  needs: ["ai-policy-gate"]

# ===========================================
# SECURITY SCAN
# ===========================================
trivy_scan:
  stage: scan
  image: aquasec/trivy:0.51.1
  script:
    - trivy fs --exit-code 0 --severity CRITICAL,HIGH --no-progress .
  needs: ["go_test", "node_test"]
  allow_failure: true

# ===========================================
# BUILD & PUSH TO HARBOR
# ===========================================
docker_build_go:
  stage: build
  <<: *docker_template
  rules:
    - exists:
        - go-proxy/Dockerfile
      if: $HARBOR_USERNAME && $HARBOR_PASSWORD
  script:
    - echo "$HARBOR_PASSWORD" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" --password-stdin
    - docker build -t "$GO_IMAGE:$CI_COMMIT_SHORT_SHA" -t "$GO_IMAGE:latest" go-proxy/
    - docker push "$GO_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker push "$GO_IMAGE:latest"
  needs: ["go_test", "trivy_scan"]

docker_build_node:
  stage: build
  <<: *docker_template
  rules:
    - exists:
        - proxy/Dockerfile
      if: $HARBOR_USERNAME && $HARBOR_PASSWORD
  script:
    - echo "$HARBOR_PASSWORD" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" --password-stdin
    - docker build -t "$NODE_IMAGE:$CI_COMMIT_SHORT_SHA" -t "$NODE_IMAGE:latest" proxy/
    - docker push "$NODE_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker push "$NODE_IMAGE:latest"
  needs: ["node_test", "trivy_scan"]

# ===========================================
# DEPLOY
# ===========================================
deploy:
  stage: deploy
  image: argoproj/argocd:v2.10.7
  rules:
    - if: $ARGOCD_SERVER && $ARGOCD_USERNAME && $ARGOCD_PASSWORD
      when: manual
  script:
    - argocd login "$ARGOCD_SERVER" --username "$ARGOCD_USERNAME" --password "$ARGOCD_PASSWORD" --insecure
    - argocd app sync keycloak-proxy --prune || echo "App not configured"
  needs: ["docker_build_go", "docker_build_node"]
  allow_failure: true
