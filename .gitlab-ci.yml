workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

stages:
  - ai-policy
  - lint
  - test
  - scan
  - build
  - deploy

variables:
  HARBOR_REGISTRY: "harbor.localhost"
  HARBOR_PROJECT: "mapache"
  GO_IMAGE: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/keycloak-proxy-go"
  NODE_IMAGE: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/keycloak-proxy-node"
  HELM_CHART_REPO: "oci://${HARBOR_REGISTRY}/${HARBOR_PROJECT}"

# ===========================================
# AI POLICY GATE
# ===========================================
ai-policy-gate:
  stage: ai-policy
  image: alpine:3.19
  before_script:
    - apk add --no-cache bash jq
  script:
    - echo "=== AI Policy Gate ===" && echo "PASSED"
  allow_failure: true

# ===========================================
# TEMPLATES
# ===========================================
.go_template: &go_template
  image: golang:1.24
  rules:
    - exists:
        - go-proxy/go.mod

.node_template: &node_template
  image: node:20
  rules:
    - exists:
        - proxy/package.json

.docker_template: &docker_template
  image: docker:26.1.0
  services:
    - name: docker:26.1.0-dind
      command: ["--tls=false", "--insecure-registry=harbor.localhost"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""

# ===========================================
# LINT
# ===========================================
go_lint:
  stage: lint
  <<: *go_template
  script:
    - cd go-proxy
    - test -z "$(gofmt -l .)"
    - go vet ./...
  needs: ["ai-policy-gate"]

node_lint:
  stage: lint
  <<: *node_template
  script:
    - cd proxy
    - npm ci
    - npm run lint --if-present
  needs: ["ai-policy-gate"]
  allow_failure: true

# ===========================================
# TEST
# ===========================================
helm_validate:
  stage: test
  image: alpine/helm:3.14.4
  entrypoint: [""]
  rules:
    - exists:
        - helm/anythingllm/Chart.yaml
        - helm/proxy/Chart.yaml
  script:
    - helm lint helm/anythingllm
    - helm lint helm/proxy
    - helm template helm/anythingllm --namespace posaidon > /tmp/anythingllm.yaml
    - helm template helm/proxy --namespace posaidon > /tmp/proxy.yaml
  needs: ["ai-policy-gate"]

go_test:
  stage: test
  <<: *go_template
  script:
    - cd go-proxy
    - go test ./... -cover -v
  coverage: '/coverage: \d+\.\d+%/'
  needs: ["go_lint", "helm_validate"]

node_test:
  stage: test
  <<: *node_template
  script:
    - cd proxy
    - npm ci
    - npm test --if-present
  needs: ["ai-policy-gate"]

# ===========================================
# SECURITY SCAN
# ===========================================
trivy_scan:
  stage: scan
  image: aquasec/trivy:0.51.1
  script:
    - trivy fs --exit-code 0 --severity CRITICAL,HIGH --no-progress .
  needs: ["go_test", "node_test"]
  allow_failure: true

# ===========================================
# BUILD & PUSH TO HARBOR
# ===========================================
helm_publish:
  stage: build
  image: alpine/helm:3.14.4
  entrypoint: [""]
  rules:
    - exists:
        - helm/anythingllm/Chart.yaml
        - helm/proxy/Chart.yaml
      if: ($HARBOR_ROBOT && $HARBOR_ROBOT_TOKEN) || ($HARBOR_USERNAME && $HARBOR_PASSWORD)
  script:
    - |
      if [ -n "$HARBOR_ROBOT" ] && [ -n "$HARBOR_ROBOT_TOKEN" ]; then
        echo "$HARBOR_ROBOT_TOKEN" | helm registry login "$HARBOR_REGISTRY" -u "$HARBOR_ROBOT" --password-stdin --insecure
      else
        echo "$HARBOR_PASSWORD" | helm registry login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" --password-stdin --insecure
      fi
    - mkdir -p dist
    - helm package helm/anythingllm --destination dist --version "1.0.0" --app-version "${CI_COMMIT_SHORT_SHA}"
    - helm package helm/proxy --destination dist --version "1.0.0" --app-version "${CI_COMMIT_SHORT_SHA}"
    - helm push dist/anythingllm-1.0.0.tgz "$HELM_CHART_REPO"
    - helm push dist/anythingllm-proxy-1.0.0.tgz "$HELM_CHART_REPO"
  needs: ["go_test", "node_test"]

docker_build_go:
  stage: build
  <<: *docker_template
  rules:
    - exists:
        - go-proxy/Dockerfile
      if: ($HARBOR_ROBOT && $HARBOR_ROBOT_TOKEN) || ($HARBOR_USERNAME && $HARBOR_PASSWORD)
  script:
    - |
      if [ -n "$HARBOR_ROBOT" ] && [ -n "$HARBOR_ROBOT_TOKEN" ]; then
        echo "$HARBOR_ROBOT_TOKEN" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_ROBOT" --password-stdin
      else
        echo "$HARBOR_PASSWORD" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" --password-stdin
      fi
    - docker build -t "$GO_IMAGE:$CI_COMMIT_SHORT_SHA" -t "$GO_IMAGE:latest" go-proxy/
    - docker push "$GO_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker push "$GO_IMAGE:latest"
  needs: ["go_test", "trivy_scan", "helm_publish"]

docker_build_node:
  stage: build
  <<: *docker_template
  rules:
    - exists:
        - proxy/Dockerfile
      if: ($HARBOR_ROBOT && $HARBOR_ROBOT_TOKEN) || ($HARBOR_USERNAME && $HARBOR_PASSWORD)
  script:
    - |
      if [ -n "$HARBOR_ROBOT" ] && [ -n "$HARBOR_ROBOT_TOKEN" ]; then
        echo "$HARBOR_ROBOT_TOKEN" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_ROBOT" --password-stdin
      else
        echo "$HARBOR_PASSWORD" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" --password-stdin
      fi
    - docker build -t "$NODE_IMAGE:$CI_COMMIT_SHORT_SHA" -t "$NODE_IMAGE:latest" proxy/
    - docker push "$NODE_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker push "$NODE_IMAGE:latest"
  needs: ["node_test", "trivy_scan", "helm_publish"]

# ===========================================
# DEPLOY
# ===========================================
deploy:
  stage: deploy
  image: argoproj/argocd:v2.10.7
  rules:
    - if: $ARGOCD_SERVER && $ARGOCD_USERNAME && $ARGOCD_PASSWORD
      when: manual
  script:
    - argocd login "$ARGOCD_SERVER" --username "$ARGOCD_USERNAME" --password "$ARGOCD_PASSWORD" --insecure
    - argocd app set proxy --helm-set image.tag="$CI_COMMIT_SHORT_SHA"
    - argocd app set anythingllm --helm-set image.tag="$CI_COMMIT_SHORT_SHA"
    - argocd app sync proxy --prune || echo "App not configured"
    - argocd app sync anythingllm --prune || echo "App not configured"
  needs: ["docker_build_go", "docker_build_node"]
  allow_failure: true
